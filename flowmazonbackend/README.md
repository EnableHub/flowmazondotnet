## Configuration

### Sources of Configuration Data

Generic Host in .NET Core loads configuartion key/value pairs from a number of sources by default, including environment variables. The sources and their load order are [detailed here](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/?view=aspnetcore-9.0).

You can also add optional sources of configuration data such as Azure App Configuration.

For actual sources of configuration data in a particular (local or non-local) environment of this app, see environment definition in project wiki.

### Required Configuration Keys

The following confguration settings must be provided:

- `ConnectionStrings__FlowmazonDB`
  This is the connection string to the database that app (for which this image is built) uses.

- `ALLOWED_CORS_ORIGINS`
  This is a semicolon-separated list of allowed CORS origins that the app would accept connections from when request is made from a browser.

  Example: `http://localhost:4000`

  **This does need to be set to a valid value,** even if the app is not supposed take requests from a browser. **Therefore in API integration tests, I set it to a dummy value ( e.g. `http://localhost`)**.

### Observability Configuration

**For Observability,** the following keys should be provided otherwise no telemetry would be received in the observability backend (some local environments do not generate telemetry and so may not provides values for these; see relevant evironment's definition for details):

- `OTEL_EXPORTER_OTLP_ENDPOINT`: URL of an OpenTelemetry Protocol (OTLP) ingestion endpoint to which telemetry would be written using Open Telemetry.
- `OTEL_EXPORTER_OTLP_PROTOCOL`: The transport, e.g. `grpc` or `http/protobuf`, that would be used to write telemetry to the OTLP endpoint.
- `OTEL_EXPORTER_OTLP_HEADERS`: Authorization header that would be provided to the observability backend. Grafana Cloud would show this if you press **Details** button on your **Stack**, then generate a new token; base-64 encoded value of this token would be included in the generated Authorization header that would be shown.
- `OTEL_RESOURCE_ATTRIBUTES`: This is used to provide value of environment, an attribute named [`deployment.environment.name`](https://opentelemetry.io/docs/specs/semconv/resource/deployment-environment/), for the Resource when sending telemetry, for example `production`, `staging` or `local_testing`.
  See Environments in the wiki for the value of this attribute in each environment.

### Optional Configuration Keys

The ASP.NET Core accepts several configuration settings which are all optional.

- One optional seting is `ASPNETCORE_ENVIRONMENT` which defaults to `Development` but in a Docker image for this app, the base ASP.NET Core image for the app image sets it to `Production`.

- The other is `ASPNETCORE_URLS` which determined the address/domain name and/or port at which KEstrel listens. For example:
  - in the standard Dockerfile for an ASP.NET Core app generatd by VS Code (see [Dockerfile for flowmazonapi](../Dockerfile) that was autogenerated in this way then changed), as well as in the base Microsoft ASP.NET Core, this is set to `http://+:8080` so Kestrel listens on port 8080 but on any IP address and domain name. It is also exposed to other containers on the same Docker network via `EXPOSE 8080` directive that is also part of the autogenerated Dockerfile.

  ASIDE: Port 8080 is not used at all outside the contianer. This is because the client Next.js app, while served from a container running in the same Docker network (created by Docker Compose file for Local Continuous Testing), runs in a browser (whether created by Playwright or manually by us) on the host machine. This app then accesses the .NET Core API from the browser and so port 8080 mapped to port on the host machine using `ports` property of `flowmazonbackend` service in the Docker Compose file.
